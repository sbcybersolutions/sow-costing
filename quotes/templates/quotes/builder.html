{% extends 'quotes/base.html' %}

{% block title %}SoW Builder{% endblock %}

{% block content %}
<div class="row">
  <!-- Main builder area -->
  <div class="col-md-8">

    <h2 class="mb-4">Build Quote for {{ client_name }}</h2>

    <!-- Accordion for add forms -->
    <div class="accordion" id="quoteForms">

      <!-- Add Course -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCourse">
            Add Course
          </button>
        </h2>
        <div id="collapseCourse" class="accordion-collapse collapse">
          <div class="accordion-body">
            <form method="post">
              {% csrf_token %}
              {{ course_form.as_p }}
              <button type="submit" name="add_course" class="btn btn-primary">Add Course</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Live Video -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLiveVideo">
            Add Live Video
          </button>
        </h2>
        <div id="collapseLiveVideo" class="accordion-collapse collapse">
          <div class="accordion-body">
            <form method="post">
              {% csrf_token %}
              {{ live_video_form.as_p }}
              <button type="submit" name="add_live_video" class="btn btn-primary">Add Live Video</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Talent -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTalent">
            Add Talent
          </button>
        </h2>
        <div id="collapseTalent" class="accordion-collapse collapse">
          <div class="accordion-body">
            <form method="post">
              {% csrf_token %}
              {{ talent_form.as_p }}
              <button type="submit" name="add_talent" class="btn btn-primary">Add Talent</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Animated Video -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnimatedVideo">
            Add Animated Video
          </button>
        </h2>
        <div id="collapseAnimatedVideo" class="accordion-collapse collapse">
          <div class="accordion-body">
            <form method="post">
              {% csrf_token %}
              {{ animated_video_form.as_p }}
              <button type="submit" name="add_animated_video" class="btn btn-primary">Add Animated Video</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Studio -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStudio">
            Add Studio
          </button>
        </h2>
        <div id="collapseStudio" class="accordion-collapse collapse">
          <div class="accordion-body">
            <form method="post">
              {% csrf_token %}
              {{ studio_form.as_p }}
              <button type="submit" name="add_studio" class="btn btn-primary">Add Studio</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Technical Staff -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTechnical">
            Add Technical Staff & Editing
          </button>
        </h2>
        <div id="collapseTechnical" class="accordion-collapse collapse">
          <div class="accordion-body">
            <form method="post">
              {% csrf_token %}
              {{ technical_form.as_p }}
              <button type="submit" name="add_technical" class="btn btn-primary">Add Technical</button>
            </form>
          </div>
        </div>
      </div>

    </div>

    <!-- Current Items -->
    <hr class="my-4">

    <h4>Quote Items</h4>

    <h5>Courses:</h5>
    <ul>
      {% for c in courses %}
        <li>{{ c }} 
          <a href="{% url 'delete_item' 'course' c.id %}" class="btn btn-sm btn-danger">Delete</a>
        </li>
      {% empty %}
        <li>No courses added yet.</li>
      {% endfor %}
    </ul>

    <h5>Live Videos:</h5>
    <ul>
      {% for lv in live_videos %}
        <li>{{ lv }} 
          <a href="{% url 'delete_item' 'livevideo' lv.id %}" class="btn btn-sm btn-danger">Delete</a>
        </li>
      {% empty %}
        <li>No live videos added yet.</li>
      {% endfor %}
    </ul>

    <h5>Talents:</h5>
    <ul>
      {% for t in talents %}
        <li>{{ t }} 
          <a href="{% url 'delete_item' 'talent' t.id %}" class="btn btn-sm btn-danger">Delete</a>
        </li>
      {% empty %}
        <li>No talents added yet.</li>
      {% endfor %}
    </ul>

    <h5>Animated Videos:</h5>
    <ul>
      {% for av in animated_videos %}
        <li>{{ av }} 
          <a href="{% url 'delete_item' 'animatedvideo' av.id %}" class="btn btn-sm btn-danger">Delete</a>
        </li>
      {% empty %}
        <li>No animated videos added yet.</li>
      {% endfor %}
    </ul>

    <h5>Studios:</h5>
    <ul>
      {% for s in studios %}
        <li>{{ s }} 
          <a href="{% url 'delete_item' 'studio' s.id %}" class="btn btn-sm btn-danger">Delete</a>
        </li>
      {% empty %}
        <li>No studios added yet.</li>
      {% endfor %}
    </ul>

    <h5>Technical Staff:</h5>
    <ul>
      {% for tech in technical_staff %}
        <li>{{ tech }} 
          <a href="{% url 'delete_item' 'technical' tech.id %}" class="btn btn-sm btn-danger">Delete</a>
        </li>
      {% empty %}
        <li>No technical staff added yet.</li>
      {% endfor %}
    </ul>

    <a href="{% url 'clear_all' %}" class="btn btn-warning mt-3">Start Over</a>
    <a href="{% url 'quote_review' %}" class="btn btn-success mt-4">Done â€” Review Quote</a>

  </div>

  <!-- Sidebar for live totals -->
  <div class="col-md-4">
    <div class="card sticky-top">
      <div class="card-header bg-dark text-white">Quote Totals</div>
      <div class="card-body">
        <p><strong>Internal Cost:</strong> $<span id="totalInternal">0.00</span></p>
        <p><strong>Retail Cost:</strong> $<span id="totalRetail">0.00</span></p>
        <a href="{% url 'export_excel' %}" class="btn btn-success">Download Excel</a>
        <a href="{% url 'export_pdf' %}" class="btn btn-primary">Download PDF</a>
        <a href="{% url 'new_quote' %}" class="btn btn-danger">Start New Quote</a>


      </div>
    </div>
  </div>
</div>

<!-- JavaScript to update totals -->
<script>
  async function updateTotals() {
    const response = await fetch("{% url 'get_totals' %}");
    const data = await response.json();
    document.getElementById('totalInternal').innerText = data.total_internal.toFixed(2);
    document.getElementById('totalRetail').innerText = data.total_retail.toFixed(2);
  }

  // Initial load + auto-refresh every 3 seconds
  updateTotals();
  setInterval(updateTotals, 3000);
</script>

{% endblock %}
